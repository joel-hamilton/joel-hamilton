#!/usr/bin/env node

const fs = require('fs');
const readline = require('readline');
const fetch = require('node-fetch');
const { execSync } = require('child_process');

class Generator {
    constructor() {
        this.repos = null;
    }

    async generate() {
        this.repos = await this.getRepos();
        let readme = '# Joel Hamilton\n\n';
        readme += this.getIntro();
        readme += this.getTable();
        readme += this.getGuide();
        readme += this.getContributions();
        readme += '<br><br>Lovingly and dynamically generated by [scripts/generate-readme](https://github.com/joelhamilton5/joelhamilton5/blob/master/scripts/generate-readme) with icons from [devicon](https://github.com/devicons/devicon/)'

        const currentReadme = fs.readFileSync('README.md', 'utf-8');
        if (readme !== currentReadme) {
            console.log('readmes different, updating')
            fs.writeFileSync('README.md', readme);;
            execSync('git config user.name github-actions');
            execSync('git config user.email github-actions@github.com');
            execSync('git add README.md');
            execSync('git commit --amend --no-edit && git push -f');
        } else {
            console.log('readme already updated');
        }
    }

    async getRepos() {
        // fetch all my repos
        const res = await fetch('https://api.github.com/users/joelhamilton5/repos');
        const repoData = await res.json();

        // parse data from READMEs in all public repos
        const promises = repoData.filter(r => r.name !== 'joelhamilton5').map(async repo => {
            const res = await fetch(`https://raw.githubusercontent.com/joelhamilton5/${repo.name}/${repo.default_branch}/README.md`);

            const fileStream = res.body;//fs.createReadStream(res.body);
            const rl = readline.createInterface(fileStream);

            let readme = '';
            let summary = '';
            let tags = [];
            let lineNum = 0;
            for await (let line of rl) {
                line = line.trim();

                // first non-empty line after header is summary
                if (lineNum > 0 && line && !summary) {
                    summary = line;
                }

                // add any {{tags|formatted|like|this}}
                const tagMatches = line.match(/{{([\w|]*)}}/);
                if (tagMatches) {
                    tags = tags.concat(tagMatches[1].split('|').filter(str => !!str));
                }

                // Each line in input.txt will be successively available here as `line`.
                readme += `${line}\n`;
                lineNum++;
            }

            let category = '';
            if (tags.length) {
                category = tags.shift();
            }

            return {
                name: repo.name,
                url: repo.html_url,
                summary,
                category,
                tags,
                readme
            }
        })

        return Promise.all(promises);
    }

    getIntro() {
        return `Hi there! I'm a Canada-based full-stack developer with 6+ years experience building and shipping large-scale customer-facing apps. I also do a lot of tinkering and building, and I try to put as much of that up here as possible. If you're hiring (remotely or in London, ON), I'd love to talk!\n`;
    }

    getTable() {
        const rows = [
            ['', 'Well', 'A Little (but would like to know better)', 'Not Very Well (but would like to learn)'],
            ['------', '------', '------', '------'],
            ['**Frontend**', 'Javascript, Typescript, Vue/Vuex', 'React/Redux, Angular', 'React-Native, Cordova'],
            ['**Backend**', 'NodeJS, PHP, Java, Express, Laravel, MySQL, Postgres, Redis', 'Python, NumPy/Pandas, C++, Flask, Django, MongoDB, GIS Mapping', 'Ruby, Go, Kotlin, Swift, Objective-C, Rails, NestJS, GraphQL, C#/.NET'],
            ['**DevOps**', 'Bash scripting, server admin, AWS, Google Cloud Platform, Digital Ocean, Docker, Vagrant', 'Azure, Kubernetes', ''],
            ['**Fields**', 'Healthcare, eLearning, Oil & Gas', 'Finance', '']
        ];

        let table = '## Things I know\n\n';

        for (let i = 0; i < rows.length; i++) {
            const row = rows[i];
            const maxWidth = 0;
            // const maxWidth = rows.reduce((max, row) => {
            //     return Math.max(max, row.length);
            // }, 0);

            table += `|${row.map(val => val.padEnd(maxWidth)).join('|')}\n`;
        }

        return table;
    }

    getGuide() {
        let guide = "## A Hitchhiker's Guide to the Repos";
        const categories = [
            {
                name: 'building',
                displayName: 'Building Things',
                lede: 'Code integrated into physical projects',
                repos: this.repos.filter(r => r.category === 'building')
            },
            {
                name: 'scripts',
                displayName: 'Small Scripts and Executables',
                lede: 'Automate the boring things!',
                repos: this.repos.filter(r => r.category === 'scripts')
            },
            {
                name: 'learning',
                displayName: 'Just for Fun/Learning Projects',
                lede: '',
                repos: this.repos.filter(r => r.category === 'learning')
            },
        ]


        for (let category of categories) {
            guide += `\n### ${category.displayName}`;
            guide += category.lede ? `\n_${category.lede}_` : '';

            for (let repo of category.repos) {
                const tagImages = repo.tags.map(tag => `<img src="icons/${tag}/${tag}-original.svg" alt="${tag}" width="20" height="20">`);
                guide += `\n- [${repo.name}](${repo.url})`

                if (tagImages.length) {
                    guide += '&nbsp;&nbsp;' + tagImages.join('&nbsp;&nbsp;');
                }

                guide += `\n    - ${repo.summary}`;
            }
        }

        return guide;
    }

    getContributions() {
        return `
## Open-source Contributions
- [Chart.js](https://github.com/chartjs/Chart.js)
- [fullcalendar](https://github.com/fullcalendar/fullcalendar)`
    }
}

let g = new Generator;
g.generate();